# EvoAlpha OS - 自动化交易流水线

> **版本**: v1.0
> **创建时间**: 2026-01-20
> **状态**: ✅ 生产就绪

---

## 📋 架构设计

### 三层架构

```
backend/
├── data_job/          # 数据层 - 数据采集
│   ├── collectors/    # 采集器实现
│   └── utils/scheduler.py  # 数据采集调度器（独立）
│
├── quant_engine/      # 量化层 - 因子计算和策略选股
│   ├── calculators/   # RPS计算器
│   ├── runner/        # 计算和选股运行器
│   └── pool/          # 股票池管理
│
└── auto_pipeline.py   # 调度层 - 统一编排 ⭐
```

### 职责分离

| 层级 | 模块 | 职责 |
|------|------|------|
| **数据层** | `data_job/` | 数据采集（K线、估值、新闻等） |
| **量化层** | `quant_engine/` | RPS计算、策略选股、股票池管理 |
| **调度层** | `auto_pipeline.py` | 编排数据采集和量化计算的完整流程 |

---

## 🚀 快速开始

### 1. 立即运行每日流水线（测试）

```bash
cd backend

# 使用 Python 直接运行
python3 auto_pipeline.py --mode daily

# 或使用 Shell 脚本
./run_pipeline.sh --mode daily
```

**流程：**
```
数据采集 (data_job) → RPS计算 (quant_engine) → 策略选股 (quant_engine)
```

### 2. 启动定时调度器（生产环境）

```bash
cd backend

# 使用 Python 直接运行
python3 auto_pipeline.py --mode schedule

# 或使用 Shell 脚本
./run_pipeline.sh
```

**调度时间：**
- **每日流水线**：工作日 15:30（收盘后）
- **季度流水线**：每季度（1/4/7/10月）15号 08:00

---

## 📅 自动化流程

### 每日流程（工作日 15:30）

```
┌─────────────────────────────────────────┐
│ Step 1: 数据采集 (data_job)             │
│   - 个股K线 (30-45分钟)                 │
│   - 板块K线 (5-10分钟)                  │
│   - ETF K线 (10-15分钟)                 │
│   - 股票估值 (5-10分钟)                 │
│   - 连板数据 (2-5分钟)                  │
│   - 新闻舆情 (10-20分钟)                │
└──────────────┬──────────────────────────┘
               ↓
┌─────────────────────────────────────────┐
│ Step 2: RPS因子计算 (quant_engine)      │
│   - 个股RPS (10-15秒)                   │
│   - 板块RPS (1-2秒)                     │
│   - ETF RPS (0.2秒)                     │
└──────────────┬──────────────────────────┘
               ↓
┌─────────────────────────────────────────┐
│ Step 3: 策略选股 (quant_engine)         │
│   - MRGC策略 (5-10秒)                   │
│   - 结果保存到 quant_preselect_results   │
└─────────────────────────────────────────┘
```

### 季度流程（每季度15号 08:00）

```
┌─────────────────────────────────────────┐
│ Step 1: 季度数据采集 (data_job)         │
│   - 基金季度持仓 (10-15分钟)            │
│   - 财务摘要 (2-3小时)                  │
└──────────────┬──────────────────────────┘
               ↓
┌─────────────────────────────────────────┐
│ Step 2: 更新核心股票池 (quant_engine)   │
│   - 基于基金持股和北向资金筛选          │
└──────────────┬──────────────────────────┘
               ↓
┌─────────────────────────────────────────┐
│ Step 3: RPS因子计算 (quant_engine)      │
│   - 个股RPS (10-15秒)                   │
│   - 板块RPS (1-2秒)                     │
│   - ETF RPS (0.2秒)                     │
└──────────────┬──────────────────────────┘
               ↓
┌─────────────────────────────────────────┐
│ Step 4: 策略选股 (quant_engine)         │
│   - MRGC策略 (5-10秒)                   │
│   - 结果保存到 quant_preselect_results   │
└─────────────────────────────────────────┘
```

---

## 📊 运行示例

### 示例1：立即运行每日流水线

```bash
$ python3 auto_pipeline.py --mode daily

================================================================================
📅 开始每日自动化交易流水线
⏰ 开始时间: 2026-01-20 16:00:00
================================================================================

▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶
📊 Step 1/3: 数据采集 (data_job)
▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶

📡 启动数据采集...

▶️  正在运行: StockKline (预计耗时: 30-45分钟)
✅ StockKline 完成
...

📊 数据采集完成:
  ✅ 成功: 6/6

▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶
🧮 Step 2/3: RPS因子计算 (quant_engine)
▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶

🧮 启动RPS因子计算（增量模式）...
✅ StockRPS计算完成 (耗时: 12.4秒)
✅ SectorRPS计算完成 (耗时: 1.1秒)
✅ ETFRPS计算完成 (耗时: 0.2秒)

📊 RPS计算完成:
  ✅ 成功: 3/3

▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶
🎯 Step 3/3: 策略选股 (quant_engine)
▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶

🎯 启动策略选股...
✅ MRGC策略选股完成 (耗时: 8.3秒)
💡 请查看 quant_preselect_results 表获取选股结果

================================================================================
✅ 每日自动化交易流水线完成
⏰ 结束时间: 2026-01-20 17:15:00
================================================================================
```

---

## 🛠️ 故障排查

### 问题1：ModuleNotFoundError

**错误：**
```
ModuleNotFoundError: No module named 'data_job'
```

**原因**：当前工作目录不对

**解决方案：**
```bash
cd backend
python3 auto_pipeline.py --mode daily
```

### 问题2：数据库连接错误

**错误：**
```
sqlite3.OperationalError: database is locked
```

**原因**：SQLite不支持并发写入

**解决方案：**
1. 确保没有其他进程在访问数据库
2. 检查是否有其他Python进程在运行

### 问题3：RPS计算失败

**错误：**
```
没有因子数据
```

**原因**：数据库中缺少最近的数据

**解决方案：**
1. 检查数据采集是否成功
2. 确认stock_daily_prices等表有数据

---

## 📝 相关文档

- [data_job/README.md](data_job/README.md) - 数据采集模块文档
- [quant_engine/README.md](quant_engine/README.md) - 量化引擎模块文档

---

## 🔄 版本历史

### v1.0 (2026-01-20)
- ✅ 创建统一调度层
- ✅ 整合数据采集和量化计算流程
- ✅ 实现每日自动化流水线
- ✅ 实现季度自动化流水线
- ✅ 职责分离：数据层、量化层、调度层

---

**最后更新**: 2026-01-20
**维护者**: Deserce
